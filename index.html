<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Meus Investimentos</title>
<meta name="theme-color" content="#0b0f14">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
html,body{margin:0;padding:12px;font-family:-apple-system;background:#0b0f14;color:#e5e7eb;height:100%;}
h1{font-size:24px;margin-bottom:8px;}
h2{font-size:14px;margin-bottom:6px;}
.card{background:#121826;border-radius:16px;padding:12px;margin-bottom:12px;}
input,select,button{width:100%;padding:10px;border-radius:12px;border:none;background:#1f2937;color:#fff;margin-top:4px}
button{background:#3b82f6;font-weight:600;cursor:pointer}
.total{font-size:26px;color:#22c55e;font-weight:800}
.small{font-size:12px;color:#9ca3af;margin-bottom:4px;}
.red{color:#ef4444}
.sugestao{background:#1f2937;padding:12px;border-radius:12px;margin-top:8px;}
.tabs{display:flex;gap:6px;margin-bottom:12px;}
.tablink{flex:1;padding:10px;border:none;border-radius:12px;background:#1f2937;color:#fff;font-weight:600;cursor:pointer;font-size:12px;}
.tablink.active{background:#3b82f6;}
.tabcontent{display:none;}
#loading{text-align:center;margin-top:50vh;color:#fff;font-size:16px;}
table{width:100%;border-collapse:collapse;margin-top:6px;}
td,th{padding:6px;font-size:12px;}
th{color:#9ca3af;}
</style>
</head>
<body>

<h1>ğŸ“Š Meus Investimentos</h1>

<div class="tabs">
  <button class="tablink active" onclick="openTab(event,'resumo')">ğŸ“Š Resumo</button>
  <button class="tablink" onclick="openTab(event,'caixinhas')">ğŸ¦ Caixinhas</button>
  <button class="tablink" onclick="openTab(event,'ativos')">ğŸ’¹ Ativos</button>
  <button class="tablink" onclick="openTab(event,'dividendos')">ğŸ’° Dividendos</button>
</div>

<div id="loading">Carregando...</div>

<!-- ================= RESUMO ================= -->
<div id="resumo" class="tabcontent" style="display:block;">
  <div class="card" id="painelResumo">
    <div class="small">ğŸ“Œ Resumo rÃ¡pido</div>
    <div class="total" id="patrimonioResumo">R$ 0,00</div>
    <div class="small">ğŸ’° Renda Fixa</div>
    <div id="rendaFixaResumo">R$ 0,00</div>
    <div class="small">ğŸ“Š AlocaÃ§Ã£o</div>
    <div id="alocResumo" style="display:flex;gap:6px;margin-top:4px;"></div>

    <div class="small">ğŸ’¸ Aporte Mensal</div>
    <input type="number" id="aporteMensal" value="300" placeholder="R$" style="margin-bottom:8px;">
    <button onclick="atualizarAporte()" style="background:#f59e0b;">Atualizar Aporte</button>

    <div class="small">ğŸ’¡ SugestÃ£o aporte</div>
    <div id="sugResumo"></div>
  </div>

  <div class="card" id="alertas">âœ… AlocaÃ§Ã£o dentro do alvo</div>

  <div class="card">
    <button onclick="render()">ğŸ”„ Atualizar PreÃ§os</button>
  </div>

  <div class="card">
    <h2>ğŸ• AlocaÃ§Ã£o por classe</h2>
    <canvas id="grafPizza"></canvas>
  </div>

  <div class="card">
    <h2>ğŸ“Š % Atual vs % Ideal</h2>
    <canvas id="grafAlvo"></canvas>
  </div>
</div>

<!-- ================= CAIXINHAS ================= -->
<div id="caixinhas" class="tabcontent">
  <div class="card">
    <div class="small">Saldo total renda fixa</div>
    <div class="total" id="saldoRendaFixa">R$ 0,00</div>
  </div>

  <div class="card">
    <h2>â• Aporte caixinha</h2>
    <select id="caixinha">
      <option value="emergencia">Reserva de EmergÃªncia</option>
      <option value="oportunidade">Reserva de Oportunidade</option>
    </select>
    <input id="valor" type="number" placeholder="Valor do aporte">
    <button onclick="addAporte()">Adicionar</button>
  </div>

  <div class="card">
    <h2 class="red">ğŸ’¸ Saque caixinha</h2>
    <select id="caixinhaSaque">
      <option value="emergencia">Reserva de EmergÃªncia</option>
      <option value="oportunidade">Reserva de Oportunidade</option>
    </select>
    <input id="valorSaque" type="number" placeholder="Valor do saque">
    <button onclick="sacar()">Sacar</button>
  </div>
</div>

<!-- ================= ATIVOS ================= -->
<div id="ativos" class="tabcontent">
  <div class="card">
    <h2>ğŸ’¹ Adicionar Ativos</h2>
    <select id="tipoAtivo">
      <option value="AÃ§Ã£o">AÃ§Ã£o</option>
      <option value="FII">FII</option>
      <option value="ETF">ETF</option>
      <option value="Cripto">Cripto</option>
    </select>
    <input id="tickerAtivo" type="text" placeholder="Ticker (ex: VALE3, BTC)">
    <input id="qtdAtivo" type="number" placeholder="Quantidade">
    <button onclick="addAtivo()">Adicionar Ativo</button>
  </div>
  <div class="card">
    <h2>ğŸ“‹ Ativos Cadastrados</h2>
    <table id="tabelaAtivos">
      <thead><tr><th>Ativo</th><th>Classe</th><th>Qtd</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- ================= DIVIDENDOS ================= -->
<div id="dividendos" class="tabcontent">
  <div class="card">
    <h2>ğŸ’° Registrar Dividendos</h2>
    <input id="ativoDiv" type="text" placeholder="Ticker">
    <input id="valorDiv" type="number" placeholder="Valor recebido">
    <input id="dataDiv" type="date">
    <button onclick="addDividendo()">Adicionar</button>
  </div>
  <div class="card">
    <h2>ğŸ“‹ Dividendos Recebidos</h2>
    <table id="tabelaDiv">
      <thead><tr><th>Ativo</th><th>Valor (R$)</th><th>Data</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
// CONFIG
const ALVO = {"Renda Fixa":35,"FIIs":30,"AÃ§Ãµes":20,"ETFs":10,"Criptos":5};
let APORTE_MENSAL = 300;

// STORAGE
let caixinhas = JSON.parse(localStorage.getItem("caixinhas")||'{"emergencia":0,"oportunidade":0}');
let ativos = JSON.parse(localStorage.getItem("ativos")||"{}");
let dividendos = JSON.parse(localStorage.getItem("dividendos")||"[]");

function salvar(){
  localStorage.setItem("caixinhas", JSON.stringify(caixinhas));
  localStorage.setItem("ativos", JSON.stringify(ativos));
  localStorage.setItem("dividendos", JSON.stringify(dividendos));
}

// ABAS
function openTab(evt, tabName){
  document.querySelectorAll(".tabcontent").forEach(t=>t.style.display="none");
  document.querySelectorAll(".tablink").forEach(b=>b.classList.remove("active"));
  document.getElementById(tabName).style.display="block";
  evt.currentTarget.classList.add("active");
}

// CAIXINHAS
function addAporte(){let c=document.getElementById("caixinha").value;let v=parseFloat(document.getElementById("valor").value);if(!v)return alert("Preencha o valor");caixinhas[c]+=v;salvar();render();}
function sacar(){let c=document.getElementById("caixinhaSaque").value;let v=parseFloat(document.getElementById("valorSaque").value);if(!v)return alert("Preencha o valor");if(v>caixinhas[c])return alert("Saldo insuficiente");caixinhas[c]-=v;salvar();render();}

// ATIVOS
function addAtivo(){
  let tipo=document.getElementById("tipoAtivo").value;
  let ticker=document.getElementById("tickerAtivo").value.trim().toUpperCase();
  let qtd=parseFloat(document.getElementById("qtdAtivo").value);
  if(!ticker||!qtd)return alert("Preencha ticker e quantidade");
  if(ativos[ticker])ativos[ticker].qtd+=qtd;
  else ativos[ticker]={classe:tipo,qtd:qtd};
  salvar();render();
  document.getElementById("tickerAtivo").value="";
  document.getElementById("qtdAtivo").value="";
}

// DIVIDENDOS
function addDividendo(){
  let ticker=document.getElementById("ativoDiv").value.trim().toUpperCase();
  let valor=parseFloat(document.getElementById("valorDiv").value);
  let data=document.getElementById("dataDiv").value;
  if(!ticker||!valor||!data)return alert("Preencha todos os campos");
  dividendos.push({ativo:ticker,valor:valor,data:data});
  salvar();renderDivid();
  document.getElementById("ativoDiv").value="";document.getElementById("valorDiv").value="";document.getElementById("dataDiv").value="";
}
function renderDivid(){
  const tbody=document.querySelector("#tabelaDiv tbody");tbody.innerHTML="";
  dividendos.forEach(d=>{
    let tr=document.createElement("tr");
    tr.innerHTML=`<td>${d.ativo}</td><td>R$ ${d.valor.toFixed(2)}</td><td>${d.data}</td>`;
    tbody.appendChild(tr);
  });
}

// COTAÃ‡ÃƒO SIMPLIFICADA (apenas dummy valores para nÃ£o travar)
async function cotacao(t){
  return 10; // valor fixo para evitar travamentos
}

// ATUALIZAR APORTES
function atualizarAporte(){
  let val=parseFloat(document.getElementById("aporteMensal").value);
  if(val>0)APORTE_MENSAL=val;
  render();
}

// RENDER PRINCIPAL
let chartPizza, chartAlvo;
async function render(){
  document.getElementById("loading").style.display="block";

  let rendaFixa=caixinhas["emergencia"]+caixinhas["oportunidade"],acoes=0,fii=0,etf=0,cripto=0;
  for(let t in ativos){let v=await cotacao(t)*ativos[t].qtd;if(ativos[t].classe==="AÃ§Ã£o")acoes+=v;if(ativos[t].classe==="FII")fii+=v;if(ativos[t].classe==="ETF")etf+=v;if(ativos[t].classe==="Cripto")cripto+=v;}
  let total=rendaFixa+acoes+fii+etf+cripto;

  document.getElementById("patrimonioResumo").innerText = "R$ "+total.toLocaleString("pt-BR",{minimumFractionDigits:2});
  document.getElementById("rendaFixaResumo").innerText = "R$ "+rendaFixa.toLocaleString("pt-BR",{minimumFractionDigits:2});

  let porcentagens={};
  for(let c in ALVO){porcentagens[c]=total>0?((c==="Renda Fixa"?rendaFixa:c==="FIIs"?fii:c==="AÃ§Ãµes"?acoes:c==="ETFs"?etf:cripto)/total*100):0;}

  let divAloc=document.getElementById("alocResumo");divAloc.innerHTML="";
  for(let c in ALVO){
    let bar=document.createElement("div");
    bar.style.flex = porcentagens[c];
    bar.style.height="12px";
    bar.style.backgroundColor=c==="Renda Fixa"?"#22c55e":c==="FIIs"?"#3b82f6":c==="AÃ§Ãµes"?"#f59e0b":c==="ETFs"?"#8b5cf6":"#ef4444";
    bar.title = `${c}: ${porcentagens[c].toFixed(1)}%`;
    divAloc.appendChild(bar);
  }

  let divSug=document.getElementById("sugResumo");let sugestao={};let totalDif=0;
  for(let c in ALVO)if(porcentagens[c]<ALVO[c])totalDif+=(ALVO[c]-porcentagens[c]);
  for(let c in ALVO)if(porcentagens[c]<ALVO[c])sugestao[c]=((ALVO[c]-porcentagens[c])/totalDif)*APORTE_MENSAL;
  let htmlSug="";for(let c in sugestao)htmlSug+=`${c}: R$ ${sugestao[c].toFixed(2)}<br>`;
  divSug.innerHTML = htmlSug || "âœ… AlocaÃ§Ã£o dentro do alvo";

  const dataPizza=[rendaFixa,fii,acoes,etf,cripto];
  if(chartPizza){chartPizza.data.datasets[0].data=dataPizza;chartPizza.update();}
  else{chartPizza=new Chart(document.getElementById("grafPizza"),{type:"doughnut",data:{labels:["Renda Fixa","FIIs","AÃ§Ãµes","ETFs","Criptos"],datasets:[{data:dataPizza,backgroundColor:["#22c55e","#3b82f6","#f59e0b","#8b5cf6","#ef4444"]}]},options:{animation:{duration:1000},plugins:{legend:{position:"bottom"}}}});}

  if(chartAlvo){chartAlvo.data.datasets[0].data=Object.values(porcentagens);chartAlvo.update();}
  else{chartAlvo=new Chart(document.getElementById("grafAlvo"),{type:"bar",data:{labels:["Renda Fixa","FIIs","AÃ§Ãµes","ETFs","Criptos"],datasets:[{label:"% Atual", data:Object.values(porcentagens), backgroundColor:"#3b82f6"},{label:"% Ideal", data:Object.values(ALVO), backgroundColor:"#22c55e"}]},options:{responsive:true,animation:{duration:1000},plugins:{legend:{position:"bottom"}}}});}

  const divAlertas=document.getElementById("alertas");let alertas=[];
  for(let c in ALVO)if(Math.abs(porcentagens[c]-ALVO[c])>=1)alertas.push(`${c}: ${porcentagens[c].toFixed(1)}% (alvo ${ALVO[c]}%)`);
  if(alertas.length>0){divAlertas.innerHTML="âš ï¸ Desbalanceamento:<br>"+alertas.join("<br>");divAlertas.style.color="#ef4444";}
  else{divAlertas.innerHTML="âœ… AlocaÃ§Ã£o dentro do alvo";divAlertas.style.color="#22c55e";}

  renderDivid();

  // Render tabela ativos com Ã­cones
  const tbodyAtivos=document.querySelector("#tabelaAtivos tbody");tbodyAtivos.innerHTML="";
  const icones={"AÃ§Ã£o":"ğŸ“ˆ","FII":"ğŸ¢","ETF":"ğŸ“Š","Cripto":"â‚¿"};
  for(let t in ativos){
    let tr=document.createElement("tr");
    tr.innerHTML=`<td>${icones[ativos[t].classe]} ${t}</td><td>${ativos[t].classe}</td><td>${ativos[t].qtd}</td>`;
    tbodyAtivos.appendChild(tr);
  }

  document.getElementById("loading").style.display="none";
}

render();
</script>

</body>
</html>
