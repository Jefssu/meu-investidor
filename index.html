<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Meus Investimentos</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;padding:16px;font-family:-apple-system;background:#0b0f14;color:#e5e7eb}
h1{font-size:26px}
h2{font-size:16px}
.card{background:#121826;border-radius:18px;padding:16px;margin-bottom:14px}
input,select,button{
 width:100%;padding:12px;border-radius:14px;border:none;
 background:#1f2937;color:#fff;margin-top:6px
}
button{background:#3b82f6;font-weight:600}
.total{font-size:30px;color:#22c55e;font-weight:800}
.small{font-size:12px;color:#9ca3af}
.red{color:#ef4444}
</style>
</head>

<body>

<h1>ğŸ“Š Meus Investimentos</h1>

<div class="card">
 <div class="small">PatrimÃ´nio total</div>
 <div class="total" id="patrimonio">R$ 0,00</div>
</div>

<div class="card" id="alertas">âœ… AlocaÃ§Ã£o dentro do alvo</div>

<!-- BotÃ£o atualizar preÃ§os -->
<div class="card">
  <button onclick="render()">ğŸ”„ Atualizar PreÃ§os</button>
</div>

<div class="card">
 <h2>ğŸ• AlocaÃ§Ã£o por classe</h2>
 <canvas id="grafPizza"></canvas>
</div>

<div class="card">
 <h2>ğŸ“Š % Atual vs % Ideal</h2>
 <canvas id="grafAlvo"></canvas>
</div>

<div class="card" id="sugestaoAporte">ğŸ’¡ SugestÃ£o de aportes para rebalancear</div>

<h2>ğŸ¦ Caixinhas Nubank</h2>

<div class="card">
 <div class="small">Saldo total renda fixa</div>
 <div class="total" id="saldoRendaFixa">R$ 0,00</div>
</div>

<div class="card">
 <h2>â• Aporte caixinha</h2>
 <select id="caixinha">
  <option value="emergencia">Reserva de EmergÃªncia</option>
  <option value="oportunidade">Reserva de Oportunidade</option>
 </select>
 <input id="valor" type="number" placeholder="Valor do aporte">
 <input id="mes" type="month">
 <button onclick="addAporte()">Adicionar</button>
</div>

<div class="card">
 <h2 class="red">ğŸ’¸ Saque caixinha</h2>
 <select id="caixinhaSaque">
  <option value="emergencia">Reserva de EmergÃªncia</option>
  <option value="oportunidade">Reserva de Oportunidade</option>
 </select>
 <input id="valorSaque" type="number" placeholder="Valor do saque">
 <button onclick="sacar()">Sacar</button>
</div>

<h2>ğŸ’¹ Adicionar Ativos</h2>
<div class="card">
  <select id="tipoAtivo">
    <option value="AÃ§Ã£o">AÃ§Ã£o</option>
    <option value="FII">FII</option>
    <option value="ETF">ETF</option>
    <option value="Cripto">Cripto</option>
  </select>
  <input id="tickerAtivo" type="text" placeholder="Ticker (ex: VALE3, BTC)">
  <input id="qtdAtivo" type="number" placeholder="Quantidade">
  <button onclick="addAtivo()">Adicionar Ativo</button>
</div>

<script>
const CDI_ANUAL = 0.1315;
const DIAS_ANO = 252;
const TOLERANCIA = 5;
const ALVO = {"Renda Fixa":40,"FIIs":20,"AÃ§Ãµes":25,"ETFs":10,"Criptos":5};

let aportes = JSON.parse(localStorage.getItem("aportes")||"[]");
let ativos = JSON.parse(localStorage.getItem("ativos")||"{}");

function salvar(){
 localStorage.setItem("aportes",JSON.stringify(aportes));
 localStorage.setItem("ativos",JSON.stringify(ativos));
}

function diasEntre(d){
 let i=new Date(d+"-01");
 let h=new Date();
 return Math.max(1,Math.floor((h-i)/(1000*60*60*24)));
}

function aliquotaIR(d){
 if(d<=180)return 0.225;
 if(d<=360)return 0.20;
 if(d<=720)return 0.175;
 return 0.15;
}

function saldoAtual(v,d){
 let taxa=CDI_ANUAL/DIAS_ANO;
 let bruto=v*Math.pow(1+taxa,d);
 let ir=(bruto-v)*aliquotaIR(d);
 return bruto-ir;
}

function saldoRendaFixa(){
 let t=0;
 aportes.forEach(a=>t+=saldoAtual(a.valor,diasEntre(a.mes)));
 return t;
}

function addAporte(){
 let caixinha = document.getElementById("caixinha").value;
 let valor = parseFloat(document.getElementById("valor").value);
 let mes = document.getElementById("mes").value;
 if(!valor || !mes) return alert("Preencha valor e mÃªs");
 aportes.push({caixinha, valor, mes});
 salvar();
 render();
}

function sacar(){
 let caixinha = document.getElementById("caixinhaSaque").value;
 let valor = parseFloat(document.getElementById("valorSaque").value);
 if(!valor) return alert("Preencha valor do saque");
 let totalCaixinha = aportes.filter(a=>a.caixinha===caixinha).reduce((s,a)=>s+a.valor,0);
 if(valor>totalCaixinha) return alert("Saldo insuficiente");
 let restantes = valor;
 for(let i=aportes.length-1;i>=0 && restantes>0;i--){
     if(aportes[i].caixinha===caixinha){
         if(aportes[i].valor<=restantes){
             restantes-=aportes[i].valor;
             aportes.splice(i,1);
         } else {
             aportes[i].valor-=restantes;
             restantes=0;
         }
     }
 }
 salvar();
 render();
}

function addAtivo(){
  let tipo = document.getElementById("tipoAtivo").value;
  let ticker = document.getElementById("tickerAtivo").value.trim().toUpperCase();
  let qtd = parseFloat(document.getElementById("qtdAtivo").value);
  if(!ticker || !qtd) return alert("Preencha ticker e quantidade");
  if(ativos[ticker]){
    ativos[ticker].qtd += qtd;
  } else {
    ativos[ticker] = {classe: tipo, qtd: qtd};
  }
  salvar();
  render();
  document.getElementById("tickerAtivo").value="";
  document.getElementById("qtdAtivo").value="";
}

async function cotacao(t){
  try{
    const criptos = ["BTC","ETH","DOGE","BNB"];
    if(criptos.includes(t)){
      let r = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${t.toLowerCase()}&vs_currencies=brl`);
      let j = await r.json();
      return j[t.toLowerCase()]?.brl || 0;
    }
    let r=await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${t}.SA`);
    let j=await r.json();
    return j.chart.result[0].meta.regularMarketPrice||0;
  }catch{return 0}
}

function sugestaoAporte(total, porcentagens, alvo){
  let sugestao = {};
  for(let classe in alvo){
    let atual = porcentagens[classe] || 0;
    if(atual < alvo[classe]){
      sugestao[classe] = (alvo[classe]-atual)/100 * total;
    }
  }
  return sugestao;
}

async function render(){
 let rendaFixa = saldoRendaFixa();
 let acoes=0,fii=0,etf=0,cripto=0;
 for(let t in ativos){
   let p = await cotacao(t);
   let v = p*ativos[t].qtd;
   if(ativos[t].classe==="AÃ§Ã£o")acoes+=v;
   if(ativos[t].classe==="FII")fii+=v;
   if(ativos[t].classe==="ETF")etf+=v;
   if(ativos[t].classe==="Cripto")cripto+=v;
 }

 let total = rendaFixa + acoes + fii + etf + cripto;

 document.getElementById("patrimonio").innerText="R$ "+total.toLocaleString("pt-BR",{minimumFractionDigits:2});
 document.getElementById("saldoRendaFixa").innerText="R$ "+rendaFixa.toLocaleString("pt-BR",{minimumFractionDigits:2});

 new Chart(document.getElementById("grafPizza"),{
  type:"doughnut",
  data:{
   labels:["Renda Fixa","FIIs","AÃ§Ãµes","ETFs","Criptos"],
   datasets:[{data:[rendaFixa,fii,acoes,etf,cripto],backgroundColor:["#22c55e","#3b82f6","#f59e0b","#8b5cf6","#ef4444"]}]
  },
  options:{plugins:{legend:{position:"bottom"}}}
 });

 let porcentagens = {
   "Renda Fixa": (rendaFixa/total)*100,
   "FIIs": (fii/total)*100,
   "AÃ§Ãµes": (acoes/total)*100,
   "ETFs": (etf/total)*100,
   "Criptos": (cripto/total)*100
 };

 new Chart(document.getElementById("grafAlvo"),{
    type:"bar",
    data:{
        labels:["Renda Fixa","FIIs","AÃ§Ãµes","ETFs","Criptos"],
        datasets:[
            {label:"% Atual", data:Object.values(porcentagens), backgroundColor:"#3b82f6"},
            {label:"% Ideal", data:Object.values(ALVO), backgroundColor:"#22c55e"}
        ]
    },
    options:{responsive:true, plugins:{legend:{position:"bottom"}}}
 });

 let alertas = [];
 for(let c in ALVO){
   if(Math.abs(porcentagens[c]-ALVO[c])>TOLERANCIA){
     alertas.push(`${c}: ${porcentagens[c].toFixed(1)}% (alvo ${ALVO[c]}%)`);
   }
 }
 const divAlertas = document.getElementById("alertas");
 if(alertas.length>0){
   divAlertas.innerHTML = "âš ï¸ Desbalanceamento:<br>"+alertas.join("<br>");
   divAlertas.style.color="#ef4444";
 } else {
   divAlertas.innerHTML = "âœ… AlocaÃ§Ã£o dentro do alvo";
   divAlertas.style.color="#22c55e";
 }

 const divSugestao = document.getElementById("sugestaoAporte");
 let sugestao = sugestaoAporte(total, porcentagens, ALVO);
 if(Object.keys(sugestao).length===0){
   divSugestao.innerHTML = "âœ… Todas as classes estÃ£o no alvo ou acima";
   divSugestao.style.color="#22c55e";
 } else {
   let linhas=[];
   for(let c in sugestao){
     linhas.push(`${c}: R$ ${sugestao[c].toFixed(2)}`);
   }
   divSugestao.innerHTML = "ğŸ’¡ SugestÃ£o de aporte:<br>"+linhas.join("<br>");
   divSugestao.style.color="#facc15";
 }
}

render();

// AtualizaÃ§Ã£o automÃ¡tica a cada 60 segundos
setInterval(() => {
  render();
}, 60000);
</script>
</body>
</html>
