<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Meus Investimentos</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;padding:16px;font-family:-apple-system;background:#0b0f14;color:#e5e7eb}
h1{font-size:26px}
h2{font-size:16px}
.card{background:#121826;border-radius:18px;padding:16px;margin-bottom:14px}
input,select,button{
 width:100%;padding:12px;border-radius:14px;border:none;
 background:#1f2937;color:#fff;margin-top:6px
}
button{background:#3b82f6;font-weight:600}
.total{font-size:30px;color:#22c55e;font-weight:800}
.small{font-size:12px;color:#9ca3af}
table{width:100%;border-collapse:collapse;margin-top:8px}
td,th{padding:8px;font-size:13px}
th{color:#9ca3af}
.red{color:#ef4444}
</style>
</head>

<body>

<h1>üìä Meus Investimentos</h1>

<!-- TOTAL -->
<div class="card">
 <div class="small">Patrim√¥nio total</div>
 <div class="total" id="patrimonio">R$ 0,00</div>
</div>

<!-- ALERTA DE DESBALANCEAMENTO -->
<div class="card" id="alertas">‚úÖ Aloca√ß√£o dentro do alvo</div>

<!-- GR√ÅFICO PIZZA -->
<div class="card">
 <h2>üçï Aloca√ß√£o por classe</h2>
 <canvas id="grafPizza"></canvas>
</div>

<!-- GR√ÅFICO % ATUAL VS % IDEAL -->
<div class="card">
 <h2>üìä % Atual vs % Ideal</h2>
 <canvas id="grafAlvo"></canvas>
</div>

<!-- ================= CAIXINHAS ================= -->
<h2>üè¶ Caixinhas Nubank</h2>

<div class="card">
 <div class="small">Saldo total renda fixa</div>
 <div class="total" id="saldoRendaFixa">R$ 0,00</div>
</div>

<div class="card">
 <h2>‚ûï Aporte caixinha</h2>
 <select id="caixinha">
  <option value="emergencia">Reserva de Emerg√™ncia</option>
  <option value="oportunidade">Reserva de Oportunidade</option>
 </select>
 <input id="valor" type="number" placeholder="Valor do aporte">
 <input id="mes" type="month">
 <button onclick="addAporte()">Adicionar</button>
</div>

<div class="card">
 <h2 class="red">üí∏ Saque caixinha</h2>
 <select id="caixinhaSaque">
  <option value="emergencia">Reserva de Emerg√™ncia</option>
  <option value="oportunidade">Reserva de Oportunidade</option>
 </select>
 <input id="valorSaque" type="number" placeholder="Valor do saque">
 <button onclick="sacar()">Sacar</button>
</div>

<!-- ================= SCRIPT ================= -->
<script>
const CDI_ANUAL = 0.1315;
const DIAS_ANO = 252;
const TOLERANCIA = 5; // +/-5%
const ALVO = {"Renda Fixa":40,"FIIs":20,"A√ß√µes":25,"ETFs":10,"Criptos":5};

let aportes = JSON.parse(localStorage.getItem("aportes")||"[]");
let ativos = JSON.parse(localStorage.getItem("ativos")||"{}");

function salvar(){
 localStorage.setItem("aportes",JSON.stringify(aportes));
 localStorage.setItem("ativos",JSON.stringify(ativos));
}

// Fun√ß√µes financeiras
function diasEntre(d){
 let i=new Date(d+"-01");
 let h=new Date();
 return Math.max(1,Math.floor((h-i)/(1000*60*60*24)));
}

function aliquotaIR(d){
 if(d<=180)return 0.225;
 if(d<=360)return 0.20;
 if(d<=720)return 0.175;
 return 0.15;
}

function saldoAtual(v,d){
 let taxa=CDI_ANUAL/DIAS_ANO;
 let bruto=v*Math.pow(1+taxa,d);
 let ir=(bruto-v)*aliquotaIR(d);
 return bruto-ir;
}

function saldoRendaFixa(){
 let t=0;
 aportes.forEach(a=>t+=saldoAtual(a.valor,diasEntre(a.mes)));
 return t;
}

// Fun√ß√µes de aporte/saque
function addAporte(){
 let caixinha = document.getElementById("caixinha").value;
 let valor = parseFloat(document.getElementById("valor").value);
 let mes = document.getElementById("mes").value;
 if(!valor || !mes) return alert("Preencha valor e m√™s");
 aportes.push({caixinha, valor, mes});
 salvar();
 render();
}

function sacar(){
 let caixinha = document.getElementById("caixinhaSaque").value;
 let valor = parseFloat(document.getElementById("valorSaque").value);
 if(!valor) return alert("Preencha valor do saque");

 let totalCaixinha = aportes.filter(a=>a.caixinha===caixinha)
                            .reduce((s,a)=>s+a.valor,0);
 if(valor>totalCaixinha) return alert("Saldo insuficiente");

 let restantes = valor;
 for(let i=aportes.length-1;i>=0 && restantes>0;i--){
     if(aportes[i].caixinha===caixinha){
         if(aportes[i].valor<=restantes){
             restantes-=aportes[i].valor;
             aportes.splice(i,1);
         } else {
             aportes[i].valor-=restantes;
             restantes=0;
         }
     }
 }
 salvar();
 render();
}

// Cota√ß√£o Yahoo Finance
async function cotacao(t){
 try{
  let r=await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${t}.SA`);
  let j=await r.json();
  return j.chart.result[0].meta.regularMarketPrice||0;
 }catch{return 0}
}

// Renderiza√ß√£o completa
async function render(){
 let rendaFixa = saldoRendaFixa();
 let acoes=0,fii=0,etf=0,cripto=0;

 for(let t in ativos){
  let p=await cotacao(t);
  let v=p*ativos[t].qtd;
  if(ativos[t].classe==="A√ß√£o")acoes+=v;
  if(ativos[t].classe==="FII")fii+=v;
  if(ativos[t].classe==="ETF")etf+=v;
  if(ativos[t].classe==="Cripto")cripto+=v;
 }

 let total = rendaFixa + acoes + fii + etf + cripto;

 // Atualiza valores no HTML
 document.getElementById("patrimonio").innerText="R$ "+total.toLocaleString("pt-BR",{minimumFractionDigits:2});
 document.getElementById("saldoRendaFixa").innerText="R$ "+rendaFixa.toLocaleString("pt-BR",{minimumFractionDigits:2});

 // Gr√°fico pizza
 new Chart(document.getElementById("grafPizza"),{
  type:"doughnut",
  data:{
   labels:["Renda Fixa","FIIs","A√ß√µes","ETFs","Criptos"],
   datasets:[{data:[rendaFixa,fii,acoes,etf,cripto],backgroundColor:["#22c55e","#3b82f6","#f59e0b","#8b5cf6","#ef4444"]}]
  },
  options:{plugins:{legend:{position:"bottom"}}}
 });

 // % atual vs % ideal
 let porcentagens = {
   "Renda Fixa": (rendaFixa/total)*100,
   "FIIs": (fii/total)*100,
   "A√ß√µes": (acoes/total)*100,
   "ETFs": (etf/total)*100,
   "Criptos": (cripto/total)*100
 };

 new Chart(document.getElementById("grafAlvo"),{
    type:"bar",
    data:{
        labels:["Renda Fixa","FIIs","A√ß√µes","ETFs","Criptos"],
        datasets:[
            {label:"% Atual", data:Object.values(porcentagens), backgroundColor:"#3b82f6"},
            {label:"% Ideal", data:Object.values(ALVO), backgroundColor:"#22c55e"}
        ]
    },
    options:{responsive:true, plugins:{legend:{position:"bottom"}}}
 });

 // Alerta de desbalanceamento
 let alertas = [];
 for(let classe in ALVO){
   if(Math.abs(porcentagens[classe]-ALVO[classe])>TOLERANCIA){
     alertas.push(`${classe}: ${porcentagens[classe].toFixed(1)}% (alvo ${ALVO[classe]}%)`);
   }
 }
 const divAlertas = document.getElementById("alertas");
 if(alertas.length>0){
   divAlertas.innerHTML = "‚ö†Ô∏è Desbalanceamento:<br>"+alertas.join("<br>");
   divAlertas.style.color="#ef4444";
 } else {
   divAlertas.innerHTML = "‚úÖ Aloca√ß√£o dentro do alvo";
   divAlertas.style.color="#22c55e";
 }
}

render();
</script>

</body>
</html>
